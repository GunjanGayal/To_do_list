<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToDo List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">

    <!-- Logo + Add Task Button -->
    <img src="stop.png" alt="logo" width="40" height="35" class="mb-2">
    <button class="btn btn-primary mb-3" id="addTaskBtn">
        Add Task
    </button>

    <!-- Task Table -->
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>#</th>
                <th>Task Description</th>
                <th>Responsible</th>
                <th>ETA</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="taskTable"></tbody>
    </table>

    <!-- Modal -->
    <div class="modal fade" id="addTaskModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Add Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label">Task Description</label>
                        <input type="text" id="taskDescription" class="form-control" placeholder="Add your task description">
                    </div>
                    <div class="mb-3">
                        <label for="responsible" class="form-label">Responsible</label>
                        <input type="text" id="responsible" class="form-control" placeholder="Who is responsible?">
                    </div>
                    <div class="mb-3">
                        <label for="eta" class="form-label">ETA</label>
                        <input type="date" id="eta" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelBtn">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveBtn">Save Task</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Script -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ✅ ToDo App Script -->
    <script>
        const API = "http://localhost:3000/tasks";
        let tasks = [];
        let editRow = null;

        const taskModal = new bootstrap.Modal(document.getElementById('addTaskModal'));

        // ✅ Load tasks from backend when page opens
        async function loadTasks() {
            const res = await fetch(API);
            tasks = await res.json();
            renderTable();
        }

        window.onload = loadTasks;

        // ✅ Add Task button click
        document.getElementById("addTaskBtn").addEventListener("click", () => {
            editRow = null;
            document.getElementById("modalTitle").innerText = "Add Task";
            document.getElementById("saveBtn").innerText = "Save Task";
            clearModalFields();
            taskModal.show();
        });

        // ✅ Save or Update Task
        document.getElementById("saveBtn").addEventListener("click", async () => {
            const description = document.getElementById("taskDescription").value.trim();
            const responsible = document.getElementById("responsible").value.trim();
            const eta = document.getElementById("eta").value;

            if (!description || !responsible || !eta) {
                alert("Please fill all fields");
                return;
            }

            if (editRow !== null) {
                // Update task: delete old and add new
                await fetch(`${API}/${editRow}`, { method: "DELETE" });
            }

            await fetch(API, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ description, responsible, eta })
            });

            taskModal.hide();
            loadTasks();
        });

        // ✅ Delete Task
        async function deleteTask(index) {
            await fetch(`${API}/${index}`, { method: "DELETE" });
            loadTasks();
        }

        // ✅ Edit Task
        function editTask(index) {
            editRow = index;
            const t = tasks[index];
            document.getElementById("taskDescription").value = t.description;
            document.getElementById("responsible").value = t.responsible;
            document.getElementById("eta").value = t.eta;
            document.getElementById("modalTitle").innerText = "Edit Task";
            document.getElementById("saveBtn").innerText = "Update Task";
            taskModal.show();
        }

        // ✅ Clear modal fields
        function clearModalFields() {
            document.getElementById("taskDescription").value = "";
            document.getElementById("responsible").value = "";
            document.getElementById("eta").value = "";
        }

        // ✅ When modal is closed, clear all input fields
        document.getElementById('addTaskModal').addEventListener('hidden.bs.modal', clearModalFields);

        // ✅ Render Table
        function renderTable() {
            let table = document.getElementById("taskTable");
            table.innerHTML = "";
            tasks.forEach((task, index) => {
                table.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${task.description}</td>
                        <td>${task.responsible}</td>
                        <td>${task.eta}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editTask(${index})">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteTask(${index})">Delete</button>
                        </td>
                    </tr>`;
            });
        }
    </script>
</body>
</html>